CREATE OR REPLACE TABLE `sas-saude-alto-custo-hml.SBX_ALTO_CUSTO.TB_EXP_CLASSES_SINISTRO_ESTUDO_NEURO_ANALISE_LUCAS`
AS

WITH CYTE_BENEF AS (
SELECT * FROM (

SELECT 
COD_CARTEIRINHA,
NUM_IDADE_BENEF,
NUM_CPF_BENEFICIARIO,
ROW_NUMBER() OVER(PARTITION BY COD_CARTEIRINHA) R_RNK

FROM `self-service-saude.SBX_ESTRATIFICACAO.TB_DIM_BENEFICIARIOS_EP` ) WHERE R_RNK =1


)


SELECT 
       A.COD_CARTEIRINHA_BENEFICIARIO,
       A.COD_ANALITICO_BENEFICIARIO,
       A.NME_BENEFICIARIO,
       A.NME_PLANO,
       A.DSC_SEXO_BENEFICIARIO,
       B.NUM_IDADE_BENEF,
       B.NUM_CPF_BENEFICIARIO,
       A.NME_MUNICIPIO_PRESTADOR,
       A.SGL_UF_PRESTADOR,
       A.NME_FANTASIA_PRESTADOR,
       A.FLG_LIMINAR,
       A.COD_SERVICO,
       A.DSC_SERVICO,
       A.NME_MUNICIPIO_TITULAR_BENEFICIARIO,
       A.SIG_UF,
       A.NUM_VPP,
       A.NUM_SOLICITACAO_VPP,
       A.DAT_EXECUCAO_SINISTRO,
       A.VLR_PAGO_SERVICO,
       A.VLR_PAGO_INTERNACAO_TOTAL

FROM `sas-saude-alto-custo-hml.SBX_ALTO_CUSTO.TB_EXP_CLASSES_SINISTRO_ESTUDO_NEURO_NEW` A
LEFT JOIN CYTE_BENEF B
ON A.COD_CARTEIRINHA_BENEFICIARIO = B.COD_CARTEIRINHA

WHERE CLASSIFICACAO_NEURO IN ('ALTA', 'ALTA-ALTA')